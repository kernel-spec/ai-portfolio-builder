name: Archetype Composition Validation

on:
  pull_request:
    paths:
      - 'archetypes/**'
      - 'versions/prompt-manifest.json'
      - '.github/workflows/archetype-composition-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'archetypes/**'
      - 'versions/prompt-manifest.json'
      - '.github/workflows/archetype-composition-validation.yml'

permissions:
  contents: read

jobs:
  validate-compositions:
    runs-on: ubuntu-latest
    name: Validate Archetype Compositions
    
    steps:
      - uses: actions/checkout@v4

      # ------------------------------------------------
      # DYNAMIC ARCHETYPE DISCOVERY
      # ------------------------------------------------

      - name: Get archetype list from manifest
        id: archetypes
        run: |
          ARCHETYPES=$(jq -r '.archetypes | keys[]' versions/prompt-manifest.json)
          echo "$ARCHETYPES" > archetypes.txt
          echo "Detected archetypes:"
          cat archetypes.txt

      # ------------------------------------------------
      # COMPOSITION VALIDATION (FAIL-CLOSED)
      # ------------------------------------------------

      - name: Validate composition percentages
        run: |
          FAILED=0

          while read archetype; do
            echo "Checking $archetype"

            SUM=$(jq ".archetypes.\"$archetype\".composition | add" versions/prompt-manifest.json)

            if [ "$SUM" -ne 100 ]; then
              echo "❌ $archetype percentages must sum to 100%"
              FAILED=1
            fi

            DOMAIN_COUNT=$(jq ".archetypes.\"$archetype\".composition | length" versions/prompt-manifest.json)

            if [ "$DOMAIN_COUNT" -lt 2 ] || [ "$DOMAIN_COUNT" -gt 4 ]; then
              echo "❌ $archetype must have 2-4 domains"
              FAILED=1
            fi

          done < archetypes.txt

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

      # ------------------------------------------------
      # DOMAIN EXISTENCE VALIDATION
      # ------------------------------------------------

      - name: Validate referenced domains exist
        run: |
          FAILED=0

          while read archetype; do
            DOMAINS=$(jq -r ".archetypes.\"$archetype\".composition | keys[]" versions/prompt-manifest.json)

            for domain in $DOMAINS; do
              if ! jq -e ".domains.\"$domain\"" versions/prompt-manifest.json > /dev/null; then
                echo "❌ $archetype references missing domain: $domain"
                FAILED=1
              fi
            done

          done < archetypes.txt

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

      # ------------------------------------------------
      # PRIMARY DOMAIN EMPHASIS (HARD ENFORCEMENT)
      # ------------------------------------------------

      - name: Enforce primary domain emphasis
        run: |
          FAILED=0

          while read archetype; do
            MAX=$(jq "[.archetypes.\"$archetype\".composition[]] | max" versions/prompt-manifest.json)

            if [ "$MAX" -lt 40 ] || [ "$MAX" -gt 60 ]; then
              echo "❌ $archetype primary domain must be 40-60%"
              FAILED=1
            fi

          done < archetypes.txt

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

      # ------------------------------------------------
      # ARCHETYPE PROMPT FILE EXISTS
      # ------------------------------------------------

      - name: Ensure prompt file exists
        run: |
          FAILED=0

          while read archetype; do
            FILE="archetypes/$archetype.system.prompt.md"

            if [ ! -f "$FILE" ]; then
              echo "❌ Missing prompt file for $archetype"
              FAILED=1
            fi

          done < archetypes.txt

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

      - name: Success
        run: echo "✅ Archetype composition governance enforced."