name: Forbidden File Changes

on:
  pull_request:
    paths:
      - 'domains/**'
      - 'archetypes/**'
      - 'versions/**'
      - 'protocols/**'
      - '.github/workflows/**'
  push:
    branches:
      - main
    paths:
      - 'domains/**'
      - 'archetypes/**'
      - 'versions/**'
      - 'protocols/**'
      - '.github/workflows/**'

permissions:
  contents: read

jobs:
  check-protected-files:
    runs-on: ubuntu-latest
    name: Check Protected File Modifications
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          git diff --name-only $BASE_SHA $HEAD_SHA > changed_files.txt
          cat changed_files.txt

      # ------------------------------------------------
      # DOMAIN / ARCHETYPE GOVERNANCE (FAIL-CLOSED)
      # ------------------------------------------------

      - name: Enforce domain & archetype governance
        run: |
          VIOLATION=0

          if grep -qE "^(domains/|archetypes/)" changed_files.txt; then
            echo "Protected prompt files modified."

            if ! grep -q "^versions/prompt-lock.json$" changed_files.txt; then
              echo "❌ Prompt files modified WITHOUT updating prompt-lock.json"
              VIOLATION=1
            fi

            if ! grep -q "^versions/prompt-manifest.json$" changed_files.txt; then
              echo "❌ Prompt files modified WITHOUT updating prompt-manifest.json"
              VIOLATION=1
            fi
          fi

          if [ "$VIOLATION" -eq 1 ]; then
            exit 1
          fi

      # ------------------------------------------------
      # LOCK FILE HARD PROTECTION
      # ------------------------------------------------

      - name: Prevent standalone lock manipulation
        run: |
          if grep -q "^versions/prompt-lock.json$" changed_files.txt; then
            if ! grep -qE "^(domains/|archetypes/)" changed_files.txt; then
              echo "❌ Lock file modified without corresponding prompt changes."
              exit 1
            fi
          fi

      # ------------------------------------------------
      # PROTOCOLS = HIGH RISK (FAIL-CLOSED)
      # ------------------------------------------------

      - name: Block protocol modifications
        run: |
          if grep -q "^protocols/" changed_files.txt; then
            echo "❌ Protocol files modified."
            echo "Protocol changes require explicit governance review."
            exit 1
          fi

      # ------------------------------------------------
      # WORKFLOW SELF-PROTECTION
      # ------------------------------------------------

      - name: Protect CI workflows
        run: |
          if grep -q "^.github/workflows/" changed_files.txt; then
            echo "❌ CI workflow modification detected."
            echo "Workflow changes require explicit security review."
            exit 1
          fi

      - name: Success
        run: echo "✅ Protected file governance rules enforced."