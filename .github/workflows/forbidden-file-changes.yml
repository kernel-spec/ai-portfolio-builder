name: Forbidden File Changes

on:
  pull_request:
    paths:
      - 'domains/**'
      - 'archetypes/**'
      - 'versions/**'
      - 'protocols/**'
  push:
    branches:
      - main
    paths:
      - 'domains/**'
      - 'archetypes/**'
      - 'versions/**'
      - 'protocols/**'

permissions:
  contents: read

jobs:
  check-protected-files:
    runs-on: ubuntu-latest
    name: Check Protected File Modifications
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          echo "Comparing $BASE_SHA to $HEAD_SHA"
          git diff --name-only $BASE_SHA $HEAD_SHA > changed_files.txt
          
          echo ""
          echo "Changed files:"
          cat changed_files.txt
          echo ""

      # =====================================================
      # DOMAIN CHANGES
      # =====================================================

      - name: Check domain modifications
        run: |
          VIOLATION=0
          
          if grep -q "^domains/" changed_files.txt; then
            echo "Domain files modified:"
            grep "^domains/" changed_files.txt
            
            if ! grep -q "^versions/prompt-lock.json$" changed_files.txt; then
              echo ""
              echo "❌ Domain modified WITHOUT updating prompt-lock.json"
              VIOLATION=1
            fi
          fi
          
          if [ "$VIOLATION" -eq 1 ]; then
            exit 1
          fi

      # =====================================================
      # ARCHETYPE CHANGES
      # =====================================================

      - name: Check archetype modifications
        run: |
          VIOLATION=0
          
          if grep -q "^archetypes/" changed_files.txt; then
            echo "Archetype files modified:"
            grep "^archetypes/" changed_files.txt
            
            if ! grep -q "^versions/prompt-lock.json$" changed_files.txt; then
              echo ""
              echo "❌ Archetype modified WITHOUT updating prompt-lock.json"
              VIOLATION=1
            fi
          fi
          
          if [ "$VIOLATION" -eq 1 ]; then
            exit 1
          fi

      # =====================================================
      # LOCK FILE DIRECT MANIPULATION (FAIL-CLOSED)
      # =====================================================

      - name: Prevent direct lock file manipulation
        run: |
          if grep -q "^versions/prompt-lock.json$" changed_files.txt; then
            
            PROMPT_CHANGED=0
            
            if grep -q "^domains/" changed_files.txt || grep -q "^archetypes/" changed_files.txt; then
              PROMPT_CHANGED=1
            fi
            
            if [ "$PROMPT_CHANGED" -eq 0 ]; then
              echo ""
              echo "❌ LOCK FILE MODIFIED WITHOUT PROMPT CHANGES"
              echo ""
              echo "Direct manipulation of versions/prompt-lock.json is prohibited."
              echo "Lock file updates must be accompanied by actual prompt changes."
              echo ""
              exit 1
            else
              echo "✅ Lock file change accompanied by prompt changes"
            fi
          fi

      # =====================================================
      # PROTOCOL CHANGES (HIGH RISK – MANUAL REVIEW)
      # =====================================================

      - name: Detect protocol modifications
        run: |
          if grep -q "^protocols/" changed_files.txt; then
            echo ""
            echo "⚠️ Protocol files modified."
            echo "Manual security review required."
            echo ""
          else
            echo "No protocol changes detected."
          fi

      # =====================================================
      # SUCCESS SUMMARY
      # =====================================================

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Protected file checks PASSED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Governance enforcement is FAIL-CLOSED."
          echo ""