name: Full Governance Audit

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate-governance:
    name: Validate Hybrid Governance Integrity
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 1️⃣ Validate JSON Syntax
      # ------------------------------------------------------------
      - name: Validate JSON syntax
        run: |
          jq empty versions/prompt-manifest.json
          jq empty versions/prompt-lock.json
          jq empty cloudflare-worker/prompt-lock.json
          echo "✅ JSON syntax valid"

      # ------------------------------------------------------------
      # 2️⃣ Validate Hybrid Manifest Structure
      # ------------------------------------------------------------
      - name: Validate hybrid manifest structure
        run: |
          jq -e '.version' versions/prompt-manifest.json > /dev/null
          jq -e '.governance_mode' versions/prompt-manifest.json > /dev/null
          jq -e '.governance' versions/prompt-manifest.json > /dev/null
          jq -e '.taxonomy.domains' versions/prompt-manifest.json > /dev/null
          jq -e '.taxonomy.archetypes' versions/prompt-manifest.json > /dev/null
          jq -e '.security' versions/prompt-manifest.json > /dev/null
          jq -e '.compatibility' versions/prompt-manifest.json > /dev/null

          DOMAIN_COUNT=$(jq '.taxonomy.domains | length' versions/prompt-manifest.json)
          ARCHETYPE_COUNT=$(jq '.taxonomy.archetypes | length' versions/prompt-manifest.json)
          TOTAL_PROMPTS=$(jq '.taxonomy.total_prompts' versions/prompt-manifest.json)

          [ "$DOMAIN_COUNT" -eq 10 ] || { echo "❌ Expected 10 domains"; exit 1; }
          [ "$ARCHETYPE_COUNT" -eq 4 ] || { echo "❌ Expected 4 archetypes"; exit 1; }
          [ "$TOTAL_PROMPTS" -eq 14 ] || { echo "❌ Expected 14 total prompts"; exit 1; }

          echo "✅ Manifest structure valid"

      # ------------------------------------------------------------
      # 3️⃣ Validate Lockfile Structure
      # ------------------------------------------------------------
      - name: Validate lockfile structure
        run: |
          jq -e '.version' versions/prompt-lock.json > /dev/null
          jq -e '.lockfileVersion' versions/prompt-lock.json > /dev/null
          jq -e '.algorithm' versions/prompt-lock.json > /dev/null
          jq -e '.prompts' versions/prompt-lock.json > /dev/null

          LOCK_PROMPT_COUNT=$(jq '.prompts | length' versions/prompt-lock.json)

          [ "$LOCK_PROMPT_COUNT" -eq 14 ] || {
            echo "❌ Lockfile must contain 14 prompts"
            exit 1
          }

          echo "✅ Lockfile structure valid"

      # ------------------------------------------------------------
      # 4️⃣ Validate Version Consistency
      # ------------------------------------------------------------
      - name: Validate version consistency
        run: |
          MANIFEST_VERSION=$(jq -r '.version' versions/prompt-manifest.json)
          LOCK_VERSION=$(jq -r '.version' versions/prompt-lock.json)

          [ "$MANIFEST_VERSION" = "$LOCK_VERSION" ] || {
            echo "❌ Version mismatch"
            exit 1
          }

          echo "✅ Version consistency verified"

      # ------------------------------------------------------------
      # 5️⃣ Governance Summary
      # ------------------------------------------------------------
      - name: Governance summary
        run: |
          echo "----------------------------------------"
          echo "Hybrid Governance Validation Passed"
          echo "Version: $(jq -r '.version' versions/prompt-manifest.json)"
          echo "Domains: $(jq '.taxonomy.domains | length' versions/prompt-manifest.json)"
          echo "Archetypes: $(jq '.taxonomy.archetypes | length' versions/prompt-manifest.json)"
          echo "Total Prompts: $(jq '.taxonomy.total_prompts' versions/prompt-manifest.json)"
          echo "----------------------------------------"
