name: Hybrid Governance Validation (v1.1.0)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate-governance:
    name: Validate Hybrid Governance Integrity
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Validate JSON Syntax
      # ------------------------------------------------------------
      - name: Validate JSON syntax
        run: |
          jq empty versions/prompt-manifest.json
          jq empty versions/prompt-lock.json
          jq empty cloudflare-worker/prompt-lock.json
          echo "‚úÖ JSON syntax valid"

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Validate Hybrid Manifest Structure
      # ------------------------------------------------------------
      - name: Validate hybrid manifest structure
        run: |
          jq -e '.version' versions/prompt-manifest.json > /dev/null
          jq -e '.governance_mode' versions/prompt-manifest.json > /dev/null
          jq -e '.governance' versions/prompt-manifest.json > /dev/null
          jq -e '.taxonomy.domains' versions/prompt-manifest.json > /dev/null
          jq -e '.taxonomy.archetypes' versions/prompt-manifest.json > /dev/null
          jq -e '.security' versions/prompt-manifest.json > /dev/null
          jq -e '.compatibility' versions/prompt-manifest.json > /dev/null

          DOMAIN_COUNT=$(jq '.taxonomy.domains | length' versions/prompt-manifest.json)
          ARCHETYPE_COUNT=$(jq '.taxonomy.archetypes | length' versions/prompt-manifest.json)
          TOTAL_PROMPTS=$(jq '.taxonomy.total_prompts' versions/prompt-manifest.json)

          [ "$DOMAIN_COUNT" -eq 10 ] || { echo "‚ùå Expected 10 domains"; exit 1; }
          [ "$ARCHETYPE_COUNT" -eq 4 ] || { echo "‚ùå Expected 4 archetypes"; exit 1; }
          [ "$TOTAL_PROMPTS" -eq 14 ] || { echo "‚ùå Expected 14 total prompts"; exit 1; }

          echo "‚úÖ Manifest structure valid"

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Validate Lockfile Structure
      # ------------------------------------------------------------
      - name: Validate lockfile structure
        run: |
          jq -e '.version' versions/prompt-lock.json > /dev/null
          jq -e '.lockfileVersion' versions/prompt-lock.json > /dev/null
          jq -e '.algorithm' versions/prompt-lock.json > /dev/null
          jq -e '.prompts' versions/prompt-lock.json > /dev/null

          LOCK_PROMPT_COUNT=$(jq '.prompts | length' versions/prompt-lock.json)

          [ "$LOCK_PROMPT_COUNT" -eq 14 ] || {
            echo "‚ùå Lockfile must contain 14 prompts"
            exit 1
          }

          echo "‚úÖ Lockfile structure valid"

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Validate Version Consistency
      # ------------------------------------------------------------
      - name: Validate version consistency
        run: |
          MANIFEST_VERSION=$(jq -r '.version' versions/prompt-manifest.json)
          LOCK_VERSION=$(jq -r '.version' versions/prompt-lock.json)

          [ "$MANIFEST_VERSION" = "$LOCK_VERSION" ] || {
            echo "‚ùå Version mismatch"
            exit 1
          }

          echo "‚úÖ Version consistency verified"

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Recompute Prompt Hashes (CI Hash Enforcement)
      # ------------------------------------------------------------
      - name: Recompute Prompt Hashes
        run: |
          echo "üîí Recomputing and verifying prompt hashes..."
          
          for key in $(jq -r '.prompts | keys[]' versions/prompt-lock.json); do
            file=$(jq -r ".prompts[\"$key\"].file" versions/prompt-lock.json)
            expected=$(jq -r ".prompts[\"$key\"].hash" versions/prompt-lock.json)
            
            # Check if file exists
            if [ ! -f "$file" ]; then
              echo "‚ùå File not found: $file (agent: $key)"
              exit 1
            fi
            
            # Recompute SHA256 hash
            actual=$(sha256sum "$file" | awk '{print $1}')
            
            echo "Checking $key: $file"
            echo "  Expected: $expected"
            echo "  Actual:   $actual"
            
            if [ "$actual" != "$expected" ]; then
              echo "‚ùå Hash mismatch for $file"
              echo "   Agent: $key"
              echo "   Expected: $expected"
              echo "   Got:      $actual"
              exit 1
            fi
          done
          
          echo "‚úÖ All prompt hashes verified"

      # ------------------------------------------------------------
      # 6Ô∏è‚É£ Governance Summary
      # ------------------------------------------------------------
      - name: Governance summary
        run: |
          echo "----------------------------------------"
          echo "Hybrid Governance Validation Passed"
          echo "Version: $(jq -r '.version' versions/prompt-manifest.json)"
          echo "Domains: $(jq '.taxonomy.domains | length' versions/prompt-manifest.json)"
          echo "Archetypes: $(jq '.taxonomy.archetypes | length' versions/prompt-manifest.json)"
          echo "Total Prompts: $(jq '.taxonomy.total_prompts' versions/prompt-manifest.json)"
          echo "----------------------------------------"