name: Hybrid Governance Validation (v1.1.0)

on:
  pull_request:
    paths:
      - 'domains/**/*.md'
      - 'archetypes/**/*.md'
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'
      - '.github/workflows/governance-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'domains/**/*.md'
      - 'archetypes/**/*.md'
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'

permissions:
  contents: read

jobs:
  governance-validation:
    runs-on: ubuntu-latest
    name: Validate Hybrid Governance Integrity

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # 1️⃣ JSON SYNTAX VALIDATION
      # -------------------------------------------------
      - name: Validate JSON syntax
        run: |
          jq empty versions/prompt-manifest.json
          jq empty versions/prompt-lock.json
          echo "✅ JSON syntax valid"

      # -------------------------------------------------
      # 2️⃣ MANIFEST STRUCTURE VALIDATION
      # -------------------------------------------------
      - name: Validate hybrid manifest structure
        run: |
          jq -e '.version' versions/prompt-manifest.json > /dev/null
          jq -e '.governance' versions/prompt-manifest.json > /dev/null
          jq -e '.taxonomy' versions/prompt-manifest.json > /dev/null
          jq -e '.security' versions/prompt-manifest.json > /dev/null
          jq -e '.compatibility' versions/prompt-manifest.json > /dev/null

          DOMAIN_COUNT=$(jq '.taxonomy.domains' versions/prompt-manifest.json)
          ARCHETYPE_COUNT=$(jq '.taxonomy.archetypes' versions/prompt-manifest.json)
          TOTAL_PROMPTS=$(jq '.taxonomy.total_prompts' versions/prompt-manifest.json)

          [ "$DOMAIN_COUNT" -eq 10 ] || { echo "❌ Expected 10 domains"; exit 1; }
          [ "$ARCHETYPE_COUNT" -eq 4 ] || { echo "❌ Expected 4 archetypes"; exit 1; }
          [ "$TOTAL_PROMPTS" -eq 14 ] || { echo "❌ Expected 14 total prompts"; exit 1; }

          echo "✅ Manifest structure valid"

      # -------------------------------------------------
      # 3️⃣ LOCKFILE STRUCTURE VALIDATION
      # -------------------------------------------------
      - name: Validate lockfile structure
        run: |
          jq -e '.version' versions/prompt-lock.json > /dev/null
          jq -e '.prompts' versions/prompt-lock.json > /dev/null
          jq -e '.algorithm' versions/prompt-lock.json > /dev/null

          ALGO=$(jq -r '.algorithm' versions/prompt-lock.json)
          [ "$ALGO" = "SHA-256" ] || { echo "❌ Lockfile must use SHA-256"; exit 1; }

          LOCK_PROMPTS=$(jq '.prompts | length' versions/prompt-lock.json)
          [ "$LOCK_PROMPTS" -eq 14 ] || { echo "❌ Lockfile must contain 14 prompts"; exit 1; }

          echo "✅ Lockfile structure valid"

      # -------------------------------------------------
      # 4️⃣ VERSION CONSISTENCY
      # -------------------------------------------------
      - name: Validate version consistency
        run: |
          LOCK_VERSION=$(jq -r '.version' versions/prompt-lock.json)
          MANIFEST_VERSION=$(jq -r '.version' versions/prompt-manifest.json)

          [ "$LOCK_VERSION" = "$MANIFEST_VERSION" ] || {
            echo "❌ Version mismatch between manifest and lockfile"
            exit 1
          }

          echo "✅ Version consistency verified"

      # -------------------------------------------------
      # 5️⃣ HASH INTEGRITY CHECK
      # -------------------------------------------------
      - name: Verify prompt hashes match lockfile
        run: |
          echo "Validating SHA-256 hashes..."

          FAILED=0

          for file in domains/*.md archetypes/*.md; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              PROMPT_ID="${FILENAME%.system.prompt.md}"

              CURRENT_HASH=$(sha256sum "$file" | awk '{print $1}')
              LOCK_HASH=$(jq -r ".prompts.\"$PROMPT_ID\".hash" versions/prompt-lock.json)

              if [ "$CURRENT_HASH" != "$LOCK_HASH" ]; then
                echo "❌ Hash mismatch: $PROMPT_ID"
                FAILED=1
              fi
            fi
          done

          [ "$FAILED" -eq 0 ] || exit 1
          echo "✅ All prompt hashes match lockfile"

      # -------------------------------------------------
      # 6️⃣ FINAL SUMMARY
      # -------------------------------------------------
      - name: Governance summary
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ HYBRID GOVERNANCE VALID (v1.1.0)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "• Manifest valid"
          echo "• Lockfile valid"
          echo "• Version consistent"
          echo "• Prompt hashes verified"
          echo ""