name: Schema Validation

on:
  pull_request:
    paths:
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'
      - '.github/workflows/schema-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'

permissions:
  contents: read

jobs:
  validate-json-schema:
    runs-on: ubuntu-latest
    name: Validate Hybrid Manifest & Lock Structure

    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          jq empty versions/prompt-manifest.json
          jq empty versions/prompt-lock.json
          echo "✅ JSON syntax valid"

      - name: Validate hybrid manifest structure (v1.1.0)
        run: |
          jq -e '.version' versions/prompt-manifest.json > /dev/null || exit 1
          jq -e '.governance_mode' versions/prompt-manifest.json > /dev/null || exit 1
          jq -e '.taxonomy.domains' versions/prompt-manifest.json > /dev/null || exit 1
          jq -e '.taxonomy.archetypes' versions/prompt-manifest.json > /dev/null || exit 1
          jq -e '.security' versions/prompt-manifest.json > /dev/null || exit 1

          DOMAIN_COUNT=$(jq '.taxonomy.domains | length' versions/prompt-manifest.json)
          ARCHETYPE_COUNT=$(jq '.taxonomy.archetypes | length' versions/prompt-manifest.json)

          [ "$DOMAIN_COUNT" -eq 10 ] || { echo "❌ Expected 10 domains"; exit 1; }
          [ "$ARCHETYPE_COUNT" -eq 4 ] || { echo "❌ Expected 4 archetypes"; exit 1; }

          echo "✅ Hybrid manifest structure valid"

      - name: Validate lock file structure
        run: |
          jq -e '.version' versions/prompt-lock.json > /dev/null || exit 1
          jq -e '.lockfileVersion' versions/prompt-lock.json > /dev/null || exit 1
          jq -e '.integrity.immutable' versions/prompt-lock.json > /dev/null || exit 1
          jq -e '.prompts' versions/prompt-lock.json > /dev/null || exit 1

          PROMPT_COUNT=$(jq '.prompts | length' versions/prompt-lock.json)
          [ "$PROMPT_COUNT" -eq 14 ] || { echo "❌ Expected 14 prompts"; exit 1; }

          echo "✅ Lock structure valid"

      - name: Validate version alignment
        run: |
          LOCK_VERSION=$(jq -r '.version' versions/prompt-lock.json)
          MANIFEST_VERSION=$(jq -r '.version' versions/prompt-manifest.json)

          [ "$LOCK_VERSION" = "$MANIFEST_VERSION" ] || { echo "❌ Version mismatch"; exit 1; }

          echo "✅ Versions aligned"

      - name: Summary
        run: echo "✅ All schema validations passed (Hybrid v1.1.0)"