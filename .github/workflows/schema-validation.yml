name: Schema Validation

on:
  pull_request:
    paths:
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'
      - '.github/workflows/schema-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'

permissions:
  contents: read

jobs:
  validate-json-schema:
    runs-on: ubuntu-latest
    name: Validate JSON Schema (Hybrid v1.1.0)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # -------------------------------------------------
      # 1️⃣ JSON SYNTAX VALIDATION
      # -------------------------------------------------
      - name: Validate JSON syntax
        run: |
          echo "Validating prompt-manifest.json..."
          jq empty versions/prompt-manifest.json
          echo "✅ prompt-manifest.json is valid JSON"

          echo "Validating prompt-lock.json..."
          jq empty versions/prompt-lock.json
          echo "✅ prompt-lock.json is valid JSON"

      # -------------------------------------------------
      # 2️⃣ HYBRID MANIFEST VALIDATION
      # -------------------------------------------------
      - name: Validate manifest structure (Hybrid Governance)
        run: |
          echo "Validating hybrid governance manifest..."

          jq -e '.version == "1.1.0"' versions/prompt-manifest.json > /dev/null \
            || { echo "❌ Manifest version must be 1.1.0"; exit 1; }

          jq -e '.governance.mode == "hybrid"' versions/prompt-manifest.json > /dev/null \
            || { echo "❌ governance.mode must be 'hybrid'"; exit 1; }

          jq -e '.taxonomy.domains == 10' versions/prompt-manifest.json > /dev/null \
            || { echo "❌ taxonomy.domains must be 10"; exit 1; }

          jq -e '.taxonomy.archetypes == 4' versions/prompt-manifest.json > /dev/null \
            || { echo "❌ taxonomy.archetypes must be 4"; exit 1; }

          jq -e '.taxonomy.total_prompts == 14' versions/prompt-manifest.json > /dev/null \
            || { echo "❌ taxonomy.total_prompts must be 14"; exit 1; }

          jq -e '.taxonomy.immutability == true' versions/prompt-manifest.json > /dev/null \
            || { echo "❌ taxonomy.immutability must be true"; exit 1; }

          jq -e '.security.attestation_required_for_production_dispatch == true' versions/prompt-manifest.json > /dev/null \
            || { echo "❌ attestation_required_for_production_dispatch must be true"; exit 1; }

          echo "✅ Hybrid manifest structure is valid"

      # -------------------------------------------------
      # 3️⃣ LOCKFILE v2 VALIDATION
      # -------------------------------------------------
      - name: Validate lock file structure (v2)
        run: |
          echo "Validating prompt-lock.json structure..."

          jq -e '.version == "1.1.0"' versions/prompt-lock.json > /dev/null \
            || { echo "❌ Lockfile version must be 1.1.0"; exit 1; }

          jq -e '.lockfileVersion == 2' versions/prompt-lock.json > /dev/null \
            || { echo "❌ lockfileVersion must be 2"; exit 1; }

          jq -e '.algorithm == "SHA-256"' versions/prompt-lock.json > /dev/null \
            || { echo "❌ algorithm must be SHA-256"; exit 1; }

          jq -e '.integrity.total_prompts == 14' versions/prompt-lock.json > /dev/null \
            || { echo "❌ integrity.total_prompts must be 14"; exit 1; }

          jq -e '.integrity.immutable == true' versions/prompt-lock.json > /dev/null \
            || { echo "❌ integrity.immutable must be true"; exit 1; }

          PROMPT_COUNT=$(jq '.prompts | length' versions/prompt-lock.json)

          if [ "$PROMPT_COUNT" -ne 14 ]; then
            echo "❌ Expected 14 prompts in lockfile, found $PROMPT_COUNT"
            exit 1
          fi

          echo "✅ Lock file structure is valid"

      # -------------------------------------------------
      # 4️⃣ VALIDATE AGENT TYPES
      # -------------------------------------------------
      - name: Validate agent types
        run: |
          echo "Validating agent types..."

          DOMAIN_COUNT=$(jq '[.prompts[] | select(.type=="domain")] | length' versions/prompt-lock.json)
          ARCHETYPE_COUNT=$(jq '[.prompts[] | select(.type=="archetype")] | length' versions/prompt-lock.json)

          if [ "$DOMAIN_COUNT" -ne 10 ]; then
            echo "❌ Expected 10 domains, found $DOMAIN_COUNT"
            exit 1
          fi

          if [ "$ARCHETYPE_COUNT" -ne 4 ]; then
            echo "❌ Expected 4 archetypes, found $ARCHETYPE_COUNT"
            exit 1
          fi

          echo "✅ Agent type distribution valid"

      # -------------------------------------------------
      # 5️⃣ SUMMARY
      # -------------------------------------------------
      - name: Summary
        if: success()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ All hybrid schema validations passed"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ JSON syntax valid"
          echo "✅ Hybrid manifest structure valid"
          echo "✅ Lockfile v2 structure valid"
          echo "✅ Agent distribution valid (10 domains, 4 archetypes)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"