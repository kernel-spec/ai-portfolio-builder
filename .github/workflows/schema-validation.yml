name: Schema Validation

on:
  pull_request:
    paths:
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'
      - '.github/workflows/schema-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'
      - '.github/workflows/schema-validation.yml'

permissions:
  contents: read

jobs:
  validate-schema:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ------------------------------------------------
      # JSON SYNTAX (HARD FAIL)
      # ------------------------------------------------

      - name: Validate JSON syntax
        run: |
          jq empty versions/prompt-manifest.json || { echo "❌ Invalid manifest JSON"; exit 1; }
          jq empty versions/prompt-lock.json || { echo "❌ Invalid lock JSON"; exit 1; }

      # ------------------------------------------------
      # REQUIRED TOP-LEVEL FIELDS
      # ------------------------------------------------

      - name: Validate required fields
        run: |
          for field in version domains archetypes governance; do
            jq -e ".$field" versions/prompt-manifest.json > /dev/null || { echo "❌ Missing $field in manifest"; exit 1; }
          done

          for field in version prompts algorithm; do
            jq -e ".$field" versions/prompt-lock.json > /dev/null || { echo "❌ Missing $field in lock"; exit 1; }
          done

      # ------------------------------------------------
      # VERSION MATCH ENFORCEMENT
      # ------------------------------------------------

      - name: Enforce version match
        run: |
          LOCK_VERSION=$(jq -r '.version' versions/prompt-lock.json)
          MANIFEST_VERSION=$(jq -r '.version' versions/prompt-manifest.json)

          if [ "$LOCK_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "❌ Version mismatch between manifest and lock"
            exit 1
          fi

      # ------------------------------------------------
      # SHA-256 VALIDATION
      # ------------------------------------------------

      - name: Validate hash format
        run: |
          INVALID=$(jq -r '.prompts[].hash' versions/prompt-lock.json | grep -vE '^[a-f0-9]{64}$' || true)

          if [ -n "$INVALID" ]; then
            echo "❌ Invalid SHA-256 hash detected"
            exit 1
          fi

      - name: Validate algorithm
        run: |
          ALG=$(jq -r '.algorithm' versions/prompt-lock.json)
          if [ "$ALG" != "SHA-256" ]; then
            echo "❌ Lock file must use SHA-256"
            exit 1
          fi

      # ------------------------------------------------
      # PROMPT CROSS-REFERENCE VALIDATION
      # ------------------------------------------------

      - name: Ensure manifest prompts match lock prompts
        run: |
          FAILED=0

          MANIFEST_PROMPTS=$(jq -r '.domains | keys[], .archetypes | keys[]' versions/prompt-manifest.json | sort)
          LOCK_PROMPTS=$(jq -r '.prompts | keys[]' versions/prompt-lock.json | sort)

          if [ "$MANIFEST_PROMPTS" != "$LOCK_PROMPTS" ]; then
            echo "❌ Manifest and lock prompt IDs mismatch"
            echo "Manifest:"
            echo "$MANIFEST_PROMPTS"
            echo "Lock:"
            echo "$LOCK_PROMPTS"
            exit 1
          fi

      # ------------------------------------------------
      # DYNAMIC ARCHETYPE VALIDATION
      # ------------------------------------------------

      - name: Validate archetype compositions dynamically
        run: |
          FAILED=0

          for archetype in $(jq -r '.archetypes | keys[]' versions/prompt-manifest.json); do

            SUM=$(jq ".archetypes.\"$archetype\".composition | add" versions/prompt-manifest.json)
            if [ "$SUM" -ne 100 ]; then
              echo "❌ $archetype composition must sum to 100%"
              FAILED=1
            fi

            COUNT=$(jq ".archetypes.\"$archetype\".composition | length" versions/prompt-manifest.json)
            if [ "$COUNT" -lt 2 ] || [ "$COUNT" -gt 4 ]; then
              echo "❌ $archetype must have 2-4 domains"
              FAILED=1
            fi

          done

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

      # ------------------------------------------------
      # DOMAIN ID REGEX ENFORCEMENT
      # ------------------------------------------------

      - name: Validate domain ID pattern
        run: |
          INVALID=$(jq -r '.domains | keys[]' versions/prompt-manifest.json | grep -vE '^domain-[0-9]{2}-[a-z-]+$' || true)

          if [ -n "$INVALID" ]; then
            echo "❌ Invalid domain ID pattern detected:"
            echo "$INVALID"
            exit 1
          fi

      - name: Success
        run: echo "✅ Schema fully validated (fail-closed)."