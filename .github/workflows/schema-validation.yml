name: Hybrid Manifest & Lock Validation (v1.1.0)

on:
  pull_request:
    paths:
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'
      - '.github/workflows/schema-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'versions/prompt-manifest.json'
      - 'versions/prompt-lock.json'

permissions:
  contents: read

jobs:
  validate-hybrid-structure:
    runs-on: ubuntu-latest
    name: Validate Hybrid Manifest & Lock Structure

    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          jq empty versions/prompt-manifest.json
          jq empty versions/prompt-lock.json
          echo "✅ JSON syntax valid"

      - name: Validate hybrid manifest structure
        run: |
          jq -e '.version' versions/prompt-manifest.json > /dev/null || exit 1
          jq -e '.governance' versions/prompt-manifest.json > /dev/null || exit 1
          jq -e '.taxonomy' versions/prompt-manifest.json > /dev/null || exit 1
          jq -e '.security' versions/prompt-manifest.json > /dev/null || exit 1
          jq -e '.compatibility' versions/prompt-manifest.json > /dev/null || exit 1

          DOMAIN_COUNT=$(jq '.taxonomy.domains' versions/prompt-manifest.json)
          ARCHETYPE_COUNT=$(jq '.taxonomy.archetypes' versions/prompt-manifest.json)
          TOTAL_PROMPTS=$(jq '.taxonomy.total_prompts' versions/prompt-manifest.json)

          [ "$DOMAIN_COUNT" -eq 10 ] || { echo "❌ Expected 10 domains"; exit 1; }
          [ "$ARCHETYPE_COUNT" -eq 4 ] || { echo "❌ Expected 4 archetypes"; exit 1; }
          [ "$TOTAL_PROMPTS" -eq 14 ] || { echo "❌ Expected 14 total prompts"; exit 1; }

          echo "✅ Hybrid manifest structure valid"

      - name: Validate lock file structure
        run: |
          jq -e '.version' versions/prompt-lock.json > /dev/null || exit 1
          jq -e '.prompts' versions/prompt-lock.json > /dev/null || exit 1
          jq -e '.algorithm' versions/prompt-lock.json > /dev/null || exit 1

          ALGO=$(jq -r '.algorithm' versions/prompt-lock.json)
          [ "$ALGO" = "SHA-256" ] || { echo "❌ Lockfile must use SHA-256"; exit 1; }

          LOCK_PROMPTS=$(jq '.prompts | length' versions/prompt-lock.json)
          [ "$LOCK_PROMPTS" -eq 14 ] || { echo "❌ Lockfile must contain 14 prompts"; exit 1; }

          echo "✅ Lockfile structure valid"

      - name: Validate version consistency
        run: |
          LOCK_VERSION=$(jq -r '.version' versions/prompt-lock.json)
          MANIFEST_VERSION=$(jq -r '.version' versions/prompt-manifest.json)

          [ "$LOCK_VERSION" = "$MANIFEST_VERSION" ] || {
            echo "❌ Version mismatch between manifest and lockfile"
            exit 1
          }

          echo "✅ Version consistency verified"

      - name: Summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ HYBRID VALIDATION PASSED (v1.1.0)"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"