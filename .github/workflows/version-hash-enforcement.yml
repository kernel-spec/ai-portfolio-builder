name: Version Hash Enforcement

on:
  pull_request:
    paths:
      - 'domains/**/*.md'
      - 'archetypes/**/*.md'
      - 'versions/prompt-lock.json'
      - 'versions/prompt-manifest.json'
      - '.github/workflows/version-hash-enforcement.yml'
  push:
    branches:
      - main
    paths:
      - 'domains/**/*.md'
      - 'archetypes/**/*.md'
      - 'versions/prompt-lock.json'
      - 'versions/prompt-manifest.json'

permissions:
  contents: read

jobs:
  verify-hashes:
    runs-on: ubuntu-latest
    name: Verify Prompt Hashes Match Lock File

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure required files exist
        run: |
          if [ ! -f versions/prompt-lock.json ]; then
            echo "❌ versions/prompt-lock.json missing"
            exit 1
          fi

          if [ ! -f versions/prompt-manifest.json ]; then
            echo "❌ versions/prompt-manifest.json missing"
            exit 1
          fi

      - name: Validate JSON structure
        run: |
          jq empty versions/prompt-lock.json
          jq empty versions/prompt-manifest.json

      - name: Calculate and verify hashes
        id: calc_hashes
        run: |
          echo "Calculating SHA-256 hashes..."

          MISMATCH=0

          mapfile -t FILES < <(find domains archetypes -type f -name "*.md")

          # Fail-closed: no prompt files found
          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "❌ No prompt files found in domains/ or archetypes/"
            exit 1
          fi

          for file in "${FILES[@]}"; do
            FILENAME=$(basename "$file")
            PROMPT_ID="${FILENAME%.system.prompt.md}"

            CURRENT_HASH=$(sha256sum "$file" | awk '{print $1}')
            LOCK_HASH=$(jq -r ".prompts.\"$PROMPT_ID\".hash" versions/prompt-lock.json)

            if [ "$LOCK_HASH" = "null" ]; then
              echo "❌ Missing lock entry for: $PROMPT_ID"
              MISMATCH=1
              continue
            fi

            if [ "$CURRENT_HASH" != "$LOCK_HASH" ]; then
              echo "❌ HASH MISMATCH: $PROMPT_ID"
              MISMATCH=1
            else
              echo "✅ $PROMPT_ID OK"
            fi
          done

          echo "mismatch=$MISMATCH" >> $GITHUB_OUTPUT

      - name: Fail if mismatches detected
        if: steps.calc_hashes.outputs.mismatch == '1'
        run: exit 1

      - name: Check for orphan lock entries
        run: |
          echo "Checking for orphan lock entries..."

          ORPHAN=0

          LOCK_IDS=$(jq -r '.prompts | keys[]' versions/prompt-lock.json)

          for id in $LOCK_IDS; do
            if [ ! -f "domains/$id.system.prompt.md" ] && \
               [ ! -f "archetypes/$id.system.prompt.md" ]; then
              echo "❌ Orphan lock entry: $id"
              ORPHAN=1
            fi
          done

          if [ "$ORPHAN" -eq 1 ]; then
            exit 1
          fi

          echo "✅ No orphan lock entries"

      - name: Verify lock file version matches manifest
        run: |
          LOCK_VERSION=$(jq -r '.version' versions/prompt-lock.json)
          MANIFEST_VERSION=$(jq -r '.version' versions/prompt-manifest.json)

          if [ -z "$LOCK_VERSION" ] || [ "$LOCK_VERSION" = "null" ]; then
            echo "❌ Invalid lock file version"
            exit 1
          fi

          if [ -z "$MANIFEST_VERSION" ] || [ "$MANIFEST_VERSION" = "null" ]; then
            echo "❌ Invalid manifest version"
            exit 1
          fi

          if [ "$LOCK_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "❌ Version mismatch between lock and manifest"
            exit 1
          fi

          echo "✅ Version check passed"

      - name: Success summary
        run: echo "✅ All prompt integrity checks passed."