name: Version Hash Enforcement

on:
  pull_request:
    paths:
      - 'domains/**/*.md'
      - 'archetypes/**/*.md'
      - 'versions/prompt-lock.json'
      - '.github/workflows/version-hash-enforcement.yml'
  push:
    branches:
      - main
    paths:
      - 'domains/**/*.md'
      - 'archetypes/**/*.md'
      - 'versions/prompt-lock.json'

jobs:
  verify-hashes:
    runs-on: ubuntu-latest
    name: Verify Prompt Hashes Match Lock File
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate current hashes
        id: calc_hashes
        run: |
          echo "Calculating SHA-256 hashes for all prompt files..."
          
          MISMATCH=0
          
          # Check all domain prompts
          for file in domains/*.md; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              PROMPT_ID="${FILENAME%.system.prompt.md}"
              
              CURRENT_HASH=$(sha256sum "$file" | awk '{print $1}')
              LOCK_HASH=$(jq -r ".prompts.\"$PROMPT_ID\".hash" versions/prompt-lock.json)
              
              echo ""
              echo "Domain: $PROMPT_ID"
              echo "  File: $file"
              echo "  Current hash: $CURRENT_HASH"
              echo "  Lock file hash: $LOCK_HASH"
              
              if [ "$CURRENT_HASH" != "$LOCK_HASH" ]; then
                echo "  ❌ HASH MISMATCH DETECTED"
                MISMATCH=1
              else
                echo "  ✅ Hash matches"
              fi
            fi
          done
          
          # Check all archetype prompts
          for file in archetypes/*.md; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              PROMPT_ID="${FILENAME%.system.prompt.md}"
              
              CURRENT_HASH=$(sha256sum "$file" | awk '{print $1}')
              LOCK_HASH=$(jq -r ".prompts.\"$PROMPT_ID\".hash" versions/prompt-lock.json)
              
              echo ""
              echo "Archetype: $PROMPT_ID"
              echo "  File: $file"
              echo "  Current hash: $CURRENT_HASH"
              echo "  Lock file hash: $LOCK_HASH"
              
              if [ "$CURRENT_HASH" != "$LOCK_HASH" ]; then
                echo "  ❌ HASH MISMATCH DETECTED"
                MISMATCH=1
              else
                echo "  ✅ Hash matches"
              fi
            fi
          done
          
          echo "mismatch=$MISMATCH" >> $GITHUB_OUTPUT

      - name: Check for hash mismatches
        if: steps.calc_hashes.outputs.mismatch == '1'
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "❌ HASH VERIFICATION FAILED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "One or more prompt files have been modified without updating"
          echo "the hash in versions/prompt-lock.json."
          echo ""
          echo "This is a MANDATORY governance check. Prompt changes require:"
          echo "  1. Update the prompt file content"
          echo "  2. Recalculate the SHA-256 hash"
          echo "  3. Update versions/prompt-lock.json with the new hash"
          echo "  4. Update versions/prompt-manifest.json version if needed"
          echo "  5. Document the change in CHANGELOG.md"
          echo ""
          echo "To fix this:"
          echo "  1. Run: sha256sum <prompt-file>"
          echo "  2. Update the hash in versions/prompt-lock.json"
          echo "  3. Commit both files together"
          echo ""
          echo "Security Note: Hash mismatches are treated as security issues."
          echo "All prompt changes must be auditable and verifiable."
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          exit 1

      - name: Verify all prompts have lock entries
        run: |
          echo "Verifying all prompt files have corresponding lock file entries..."
          
          MISSING=0
          
          # Check domains
          for file in domains/*.md; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              PROMPT_ID="${FILENAME%.system.prompt.md}"
              
              if ! jq -e ".prompts.\"$PROMPT_ID\"" versions/prompt-lock.json > /dev/null; then
                echo "❌ Missing lock entry for: $PROMPT_ID"
                MISSING=1
              fi
            fi
          done
          
          # Check archetypes
          for file in archetypes/*.md; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              PROMPT_ID="${FILENAME%.system.prompt.md}"
              
              if ! jq -e ".prompts.\"$PROMPT_ID\"" versions/prompt-lock.json > /dev/null; then
                echo "❌ Missing lock entry for: $PROMPT_ID"
                MISSING=1
              fi
            fi
          done
          
          if [ "$MISSING" -eq 1 ]; then
            echo ""
            echo "❌ Some prompt files are missing from prompt-lock.json"
            echo "All prompts must have corresponding lock file entries."
            exit 1
          fi
          
          echo "✅ All prompt files have lock file entries"

      - name: Verify lock file version matches manifest
        run: |
          LOCK_VERSION=$(jq -r '.version' versions/prompt-lock.json)
          MANIFEST_VERSION=$(jq -r '.version' versions/prompt-manifest.json)
          
          echo "Lock file version: $LOCK_VERSION"
          echo "Manifest version: $MANIFEST_VERSION"
          
          if [ "$LOCK_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "❌ Version mismatch between lock file and manifest"
            echo "Both files must have the same version number."
            exit 1
          fi
          
          echo "✅ Lock file and manifest versions match"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ ALL HASH VERIFICATIONS PASSED"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "✅ All prompt file hashes match prompt-lock.json"
          echo "✅ All prompt files have lock file entries"
          echo "✅ Lock file and manifest versions match"
          echo ""
          echo "Prompt integrity verified. Changes are auditable and traceable."
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
