name: Version Hash Enforcement (Hybrid v1.1.0)

on:
  pull_request:
    paths:
      - 'domains/**/*.md'
      - 'archetypes/**/*.md'
      - 'versions/prompt-lock.json'
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  verify-hashes:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Verify SHA-256 hashes
        run: |
          FAILED=0

          for file in domains/*.md archetypes/*.md; do
            [ -f "$file" ] || continue

            ID=$(basename "$file" .system.prompt.md)
            CURRENT=$(sha256sum "$file" | awk '{print $1}')
            LOCK=$(jq -r ".prompts.\"$ID\".hash" versions/prompt-lock.json)

            [ "$CURRENT" = "$LOCK" ] || FAILED=1
          done

          [ "$FAILED" -eq 0 ] || exit 1
          echo "✅ All hashes verified"

      - name: Validate immutable flag
        run: |
          jq -e '.integrity.immutable == true' versions/prompt-lock.json > /dev/null || exit 1
          echo "✅ Lockfile immutable"

      - name: Summary
        run: echo "✅ Hash enforcement passed"